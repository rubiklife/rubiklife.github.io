---
title: "Aria2 完整指南：轻量级多协议下载工具"
date: 2025-07-28T06:00:00+08:00
categories:
  - 效率工具
tags:
  - 下载
  - 工具
  - 开源
mermaid: true
toc: true
toc_label: "目录"
toc_icon: "cog"
---

# Aria2 完整指南：轻量级多协议下载工具

## 项目概述

[Aria2](https://github.com/aria2/aria2) 是一个轻量级的多协议、多源、跨平台命令行下载工具。它支持 HTTP/HTTPS、FTP、SFTP、BitTorrent 和 Metalink 协议，具有强大的下载管理功能和灵活的配置选项。

<div style="text-align: center; margin: 20px 0;">
  <svg width="600" height="300" xmlns="http://www.w3.org/2000/svg">
    <style>
      .title { font-family: Arial; font-size: 24px; font-weight: bold; fill: #2C3E50; text-anchor: middle; }
      .subtitle { font-family: Arial; font-size: 16px; fill: #7F8C8D; text-anchor: middle; }
      .logo { font-family: Arial; font-size: 36px; font-weight: bold; fill: #E74C3C; text-anchor: middle; }
      .highlight { fill: #3498DB; }
      .badge { font-family: Arial; font-size: 12px; fill: #FFFFFF; font-weight: bold; text-anchor: middle; }
      .feature { font-family: Arial; font-size: 14px; fill: #2C3E50; }
    </style>
    <rect width="600" height="300" fill="#ECF0F1" rx="12" ry="12" stroke="#BDC3C7" stroke-width="2"/>
    <text x="300" y="60" class="logo">Aria<tspan class="highlight">2</tspan></text>
    <text x="300" y="90" class="title">多协议下载工具</text>
    <text x="300" y="115" class="subtitle">轻量级命令行下载管理器</text>
    
    <!-- GitHub Stats -->
    <rect x="50" y="140" width="80" height="25" fill="#2ECC71" rx="12" ry="12"/>
    <text x="90" y="157" class="badge">38.4k ⭐</text>
    
    <rect x="150" y="140" width="80" height="25" fill="#3498DB" rx="12" ry="12"/>
    <text x="190" y="157" class="badge">3.7k Forks</text>
    
    <rect x="250" y="140" width="100" height="25" fill="#E74C3C" rx="12" ry="12"/>
    <text x="300" y="157" class="badge">GPL-2.0</text>
    
    <!-- Key Features -->
    <text x="50" y="200" class="feature">🌐 多协议支持</text>
    <text x="200" y="200" class="feature">⚡ 高性能下载</text>
    <text x="350" y="200" class="feature">🔧 命令行工具</text>
    <text x="500" y="200" class="feature">📱 跨平台</text>
    
    <text x="50" y="230" class="feature">🔗 多源下载</text>
    <text x="200" y="230" class="feature">🎯 断点续传</text>
    <text x="350" y="230" class="feature">🛡️ 安全传输</text>
    <text x="500" y="230" class="feature">📊 详细统计</text>
    
    <text x="300" y="270" class="subtitle">官网: aria2.github.io</text>
  </svg>
</div>

## 核心特性

Aria2 提供了全面的下载解决方案，具有以下核心特性：

- **🌐 多协议支持**：HTTP/HTTPS、FTP、SFTP、BitTorrent、Metalink
- **⚡ 高性能**：多线程下载，支持并发连接
- **🔗 多源下载**：从多个源同时下载同一文件
- **🎯 断点续传**：支持下载中断后继续下载
- **🛡️ 安全传输**：支持 SSL/TLS 加密
- **📊 详细统计**：提供下载进度和速度统计
- **🔧 灵活配置**：丰富的命令行选项和配置文件
- **📱 跨平台**：支持 Linux、macOS、Windows、Android

## 系统架构

```mermaid
graph TB
    subgraph "用户层"
        A[命令行界面]
        B[RPC 接口]
        C[WebSocket 接口]
    end
    
    subgraph "协议层"
        D[HTTP/HTTPS 下载器]
        E[FTP/SFTP 下载器]
        F[BitTorrent 下载器]
        G[Metalink 解析器]
    end
    
    subgraph "核心引擎"
        H[下载管理器]
        I[连接池]
        J[文件管理器]
        K[统计收集器]
    end
    
    subgraph "存储层"
        L[配置文件]
        M[会话文件]
        N[临时文件]
        O[下载目录]
    end
    
    A --> H
    B --> H
    C --> H
    
    H --> D
    H --> E
    H --> F
    H --> G
    
    D --> I
    E --> I
    F --> I
    G --> I
    
    I --> J
    J --> K
    
    H --> L
    H --> M
    H --> N
    H --> O
    
    style A fill:#e1f5fe
    style H fill:#fff3e0
    style I fill:#e8f5e8
    style K fill:#fce4ec
```

## 安装指南

### Linux 安装

#### Ubuntu/Debian
```bash
# 使用包管理器安装
sudo apt update
sudo apt install aria2

# 或者从源码编译
sudo apt install build-essential libssl-dev libssh2-1-dev libc-ares-dev libxml2-dev zlib1g-dev libgmp-dev libssh2-1-dev libc-ares-dev libxml2-dev zlib1g-dev libgmp-dev
git clone https://github.com/aria2/aria2.git
cd aria2
./configure
make
sudo make install
```

#### CentOS/RHEL
```bash
# 使用包管理器安装
sudo yum install aria2

# 或者从源码编译
sudo yum groupinstall "Development Tools"
sudo yum install openssl-devel libssh2-devel c-ares-devel libxml2-devel zlib-devel gmp-devel
git clone https://github.com/aria2/aria2.git
cd aria2
./configure
make
sudo make install
```

### macOS 安装

```bash
# 使用 Homebrew 安装
brew install aria2

# 或者使用 MacPorts
sudo port install aria2
```

### Windows 安装

1. 下载预编译版本：https://github.com/aria2/aria2/releases
2. 解压到指定目录
3. 将 aria2c.exe 所在目录添加到 PATH 环境变量

### 验证安装

```bash
aria2c --version
```

## 基础使用

### 基本下载命令

```bash
# 下载单个文件
aria2c "https://example.com/file.zip"

# 下载到指定目录
aria2c -d /path/to/download "https://example.com/file.zip"

# 重命名下载文件
aria2c -o newname.zip "https://example.com/file.zip"

# 限制下载速度
aria2c --max-download-limit=1M "https://example.com/file.zip"
```

### 多线程下载

```bash
# 使用 16 个连接下载
aria2c -x 16 "https://example.com/file.zip"

# 使用 16 个连接，每个连接最多 5 个分片
aria2c -x 16 -s 5 "https://example.com/file.zip"
```

### 断点续传

```bash
# 启用断点续传
aria2c -c "https://example.com/file.zip"

# 从指定位置继续下载
aria2c -c -S "https://example.com/file.zip"
```

## 高级功能

### BitTorrent 下载

```bash
# 下载种子文件
aria2c "https://example.com/file.torrent"

# 指定下载目录
aria2c -d /path/to/download "https://example.com/file.torrent"

# 设置上传速度限制
aria2c --max-upload-limit=1M "https://example.com/file.torrent"

# 启用 DHT
aria2c --enable-dht "https://example.com/file.torrent"
```

### Metalink 下载

```bash
# 下载 Metalink 文件
aria2c "https://example.com/file.metalink"

# 指定首选语言
aria2c --metalink-language=zh-CN "https://example.com/file.metalink"

# 指定首选位置
aria2c --metalink-location=CN "https://example.com/file.metalink"
```

### FTP/SFTP 下载

```bash
# FTP 下载
aria2c "ftp://user:pass@example.com/file.zip"

# SFTP 下载
aria2c "sftp://user@example.com/file.zip"

# 使用 SSH 密钥
aria2c --ssh-private-key=/path/to/private_key "sftp://user@example.com/file.zip"
```

## 配置文件

### 创建配置文件

```bash
# 创建配置目录
mkdir -p ~/.aria2

# 创建配置文件
touch ~/.aria2/aria2.conf
```

### 配置文件示例

```ini
# 基本设置
dir=/home/user/Downloads
input-file=/home/user/.aria2/aria2.session
save-session=/home/user/.aria2/aria2.session
save-session-interval=60

# 连接设置
max-concurrent-downloads=5
max-connection-per-server=16
min-split-size=10M
split=10
max-overall-download-limit=0
max-download-limit=0
max-overall-upload-limit=1M
max-upload-limit=1000

# BitTorrent 设置
enable-dht=true
enable-peer-exchange=true
listen-port=6881-6999
dht-listen-port=6881-6999

# RPC 设置
enable-rpc=true
rpc-allow-origin-all=true
rpc-listen-all=true
rpc-listen-port=6800
rpc-secret=your_secret_key

# 日志设置
log=/home/user/.aria2/aria2.log
log-level=notice
```

### 使用配置文件

```bash
# 使用配置文件启动
aria2c --conf-path=/path/to/aria2.conf

# 或者使用默认位置
aria2c --conf-path=~/.aria2/aria2.conf
```

## RPC 接口

### 启动 RPC 服务

```bash
# 启动 RPC 服务
aria2c --enable-rpc --rpc-listen-all --rpc-allow-origin-all

# 指定端口和密钥
aria2c --enable-rpc --rpc-listen-port=6800 --rpc-secret=your_secret
```

### JSON-RPC 示例

```bash
# 添加下载任务
curl -X POST -H "Content-Type: application/json" \
  -d '{"jsonrpc":"2.0","id":"1","method":"aria2.addUri","params":[["https://example.com/file.zip"]]}' \
  http://localhost:6800/jsonrpc

# 获取下载状态
curl -X POST -H "Content-Type: application/json" \
  -d '{"jsonrpc":"2.0","id":"1","method":"aria2.tellStatus","params":["gid"]}' \
  http://localhost:6800/jsonrpc

# 暂停下载
curl -X POST -H "Content-Type: application/json" \
  -d '{"jsonrpc":"2.0","id":"1","method":"aria2.pause","params":["gid"]}' \
  http://localhost:6800/jsonrpc
```

## WebSocket 接口

```javascript
// 连接 WebSocket
const ws = new WebSocket('ws://localhost:6800/jsonrpc');

// 添加下载任务
ws.send(JSON.stringify({
  jsonrpc: '2.0',
  id: '1',
  method: 'aria2.addUri',
  params: [['https://example.com/file.zip']]
}));

// 监听下载进度
ws.onmessage = function(event) {
  const data = JSON.parse(event.data);
  console.log('Download progress:', data);
};
```

## 实用脚本

### 批量下载脚本

```bash
#!/bin/bash
# 批量下载脚本

# 读取 URL 列表文件
while IFS= read -r url; do
  echo "Downloading: $url"
  aria2c -c -x 16 -s 16 "$url"
done < urls.txt
```

### 监控下载进度

```bash
#!/bin/bash
# 监控下载进度

while true; do
  clear
  echo "=== Aria2 Download Status ==="
  aria2c --show-files --summary-interval=1
  sleep 2
done
```

### 自动重试脚本

```bash
#!/bin/bash
# 自动重试下载

max_retries=3
retry_count=0

while [ $retry_count -lt $max_retries ]; do
  if aria2c "$1"; then
    echo "Download completed successfully"
    break
  else
    retry_count=$((retry_count + 1))
    echo "Download failed, retrying... ($retry_count/$max_retries)"
    sleep 5
  fi
done
```

## 性能优化

### 网络优化

```bash
# 优化连接数
aria2c -x 16 -s 16 "https://example.com/file.zip"

# 启用 HTTP/2
aria2c --http-accept-gzip=true "https://example.com/file.zip"

# 设置超时
aria2c --connect-timeout=10 --timeout=10 "https://example.com/file.zip"
```

### 磁盘优化

```bash
# 使用内存缓存
aria2c --file-allocation=none "https://example.com/file.zip"

# 预分配磁盘空间
aria2c --file-allocation=prealloc "https://example.com/file.zip"

# 使用直接 I/O
aria2c --file-allocation=falloc "https://example.com/file.zip"
```

## 故障排除

### 常见问题

#### 1. 下载速度慢
```bash
# 检查网络连接
ping example.com

# 增加连接数
aria2c -x 32 -s 16 "https://example.com/file.zip"

# 检查服务器限制
aria2c --max-download-limit=0 "https://example.com/file.zip"
```

#### 2. 连接超时
```bash
# 增加超时时间
aria2c --connect-timeout=30 --timeout=30 "https://example.com/file.zip"

# 使用代理
aria2c --all-proxy="http://proxy:port" "https://example.com/file.zip"
```

#### 3. BitTorrent 连接问题
```bash
# 检查端口转发
aria2c --listen-port=6881-6999 "https://example.com/file.torrent"

# 启用 UPnP
aria2c --enable-upnp "https://example.com/file.torrent"

# 添加 tracker
aria2c --bt-tracker="udp://tracker.example.com:1337/announce" "https://example.com/file.torrent"
```

### 调试模式

```bash
# 启用详细日志
aria2c --log-level=debug "https://example.com/file.zip"

# 输出到文件
aria2c --log=/path/to/aria2.log --log-level=debug "https://example.com/file.zip"
```

## 最佳实践

### 1. 配置文件管理

```bash
# 创建多个配置文件
~/.aria2/aria2.conf          # 默认配置
~/.aria2/aria2-fast.conf     # 高速下载配置
~/.aria2/aria2-bt.conf       # BitTorrent 配置
```

### 2. 会话管理

```bash
# 保存会话状态
aria2c --save-session=/path/to/session.txt "https://example.com/file.zip"

# 从会话恢复
aria2c --input-file=/path/to/session.txt
```

### 3. 监控和统计

```bash
# 实时监控
watch -n 1 'aria2c --show-files'

# 生成统计报告
aria2c --summary-interval=1 --log=/path/to/download.log
```

## 集成示例

### 与 Python 集成

```python
import json
import requests

class Aria2Client:
    def __init__(self, rpc_url="http://localhost:6800/jsonrpc"):
        self.rpc_url = rpc_url
    
    def add_uri(self, uris, options=None):
        params = [uris]
        if options:
            params.append(options)
        
        data = {
            "jsonrpc": "2.0",
            "id": "1",
            "method": "aria2.addUri",
            "params": params
        }
        
        response = requests.post(self.rpc_url, json=data)
        return response.json()
    
    def get_status(self, gid):
        data = {
            "jsonrpc": "2.0",
            "id": "1",
            "method": "aria2.tellStatus",
            "params": [gid]
        }
        
        response = requests.post(self.rpc_url, json=data)
        return response.json()

# 使用示例
client = Aria2Client()
result = client.add_uri(["https://example.com/file.zip"])
print(f"Download started with GID: {result['result']}")
```

### 与 Node.js 集成

```javascript
const WebSocket = require('ws');

class Aria2WebSocket {
    constructor(host = 'localhost', port = 6800) {
        this.ws = new WebSocket(`ws://${host}:${port}/jsonrpc`);
        this.messageId = 1;
    }
    
    addUri(uris, options = {}) {
        const message = {
            jsonrpc: '2.0',
            id: this.messageId++,
            method: 'aria2.addUri',
            params: [uris, options]
        };
        
        this.ws.send(JSON.stringify(message));
    }
    
    onMessage(callback) {
        this.ws.on('message', (data) => {
            const message = JSON.parse(data);
            callback(message);
        });
    }
}

// 使用示例
const aria2 = new Aria2WebSocket();
aria2.addUri(['https://example.com/file.zip']);
aria2.onMessage((message) => {
    console.log('Received:', message);
});
```

## 高级配置示例

### 生产环境配置

```ini
# 生产环境配置文件 ~/.aria2/aria2-prod.conf

# 基本设置
dir=/data/downloads
input-file=/data/aria2/aria2.session
save-session=/data/aria2/aria2.session
save-session-interval=60
auto-save-interval=60

# 连接优化
max-concurrent-downloads=10
max-connection-per-server=16
min-split-size=10M
split=10
max-overall-download-limit=0
max-download-limit=0
max-overall-upload-limit=1M
max-upload-limit=1000

# 网络优化
connect-timeout=10
timeout=10
retry-wait=3
max-tries=5
retry-wait=3

# BitTorrent 优化
enable-dht=true
enable-peer-exchange=true
listen-port=6881-6999
dht-listen-port=6881-6999
bt-max-peers=55
bt-request-peer-speed-limit=50K

# RPC 设置
enable-rpc=true
rpc-allow-origin-all=true
rpc-listen-all=true
rpc-listen-port=6800
rpc-secret=your_secure_secret_key

# 日志设置
log=/var/log/aria2.log
log-level=notice
console-log-level=notice

# 安全设置
rpc-secure=false
rpc-certificate=/path/to/cert.pem
rpc-private-key=/path/to/key.pem
```

### 开发环境配置

```ini
# 开发环境配置文件 ~/.aria2/aria2-dev.conf

# 基本设置
dir=~/Downloads/aria2
input-file=~/.aria2/aria2-dev.session
save-session=~/.aria2/aria2-dev.session
save-session-interval=30

# 调试设置
log=~/.aria2/aria2-dev.log
log-level=debug
console-log-level=debug

# 开发测试设置
max-concurrent-downloads=3
max-connection-per-server=8
min-split-size=1M
split=5

# RPC 设置
enable-rpc=true
rpc-listen-all=true
rpc-listen-port=6801
rpc-secret=dev_secret

# 测试设置
max-overall-download-limit=10M
max-download-limit=5M
```

## 监控和日志分析

### 实时监控脚本

```bash
#!/bin/bash
# aria2-monitor.sh - 实时监控 Aria2 下载状态

LOG_FILE="/var/log/aria2.log"
RPC_PORT="6800"

echo "=== Aria2 实时监控 ==="
echo "时间: $(date)"
echo "========================"

# 检查 Aria2 进程
if pgrep -x "aria2c" > /dev/null; then
    echo "✅ Aria2 进程运行中"
else
    echo "❌ Aria2 进程未运行"
    exit 1
fi

# 获取下载状态
echo ""
echo "📊 当前下载任务:"
aria2c --show-files --summary-interval=1 2>/dev/null | head -20

# 检查 RPC 连接
echo ""
echo "🔌 RPC 连接状态:"
if curl -s "http://localhost:${RPC_PORT}/jsonrpc" > /dev/null; then
    echo "✅ RPC 服务正常"
else
    echo "❌ RPC 服务异常"
fi

# 显示最近的日志
echo ""
echo "📝 最近日志 (最后 10 行):"
tail -10 "$LOG_FILE" 2>/dev/null || echo "日志文件不存在"
```

### 日志分析工具

```python
#!/usr/bin/env python3
# aria2-log-analyzer.py - Aria2 日志分析工具

import re
import sys
from datetime import datetime
from collections import defaultdict

class Aria2LogAnalyzer:
    def __init__(self, log_file):
        self.log_file = log_file
        self.stats = defaultdict(int)
        self.errors = []
        self.downloads = []
    
    def analyze(self):
        """分析日志文件"""
        try:
            with open(self.log_file, 'r') as f:
                for line in f:
                    self.parse_line(line)
        except FileNotFoundError:
            print(f"错误: 日志文件 {self.log_file} 不存在")
            return
        
        self.print_report()
    
    def parse_line(self, line):
        """解析单行日志"""
        # 下载完成
        if "Download Results:" in line:
            self.stats['completed_downloads'] += 1
        
        # 下载错误
        elif "error occurred" in line.lower():
            self.stats['errors'] += 1
            self.errors.append(line.strip())
        
        # 连接错误
        elif "connection error" in line.lower():
            self.stats['connection_errors'] += 1
        
        # 超时错误
        elif "timeout" in line.lower():
            self.stats['timeout_errors'] += 1
    
    def print_report(self):
        """打印分析报告"""
        print("=== Aria2 日志分析报告 ===")
        print(f"分析时间: {datetime.now()}")
        print(f"日志文件: {self.log_file}")
        print("")
        
        print("📊 统计信息:")
        print(f"  完成下载: {self.stats['completed_downloads']}")
        print(f"  总错误数: {self.stats['errors']}")
        print(f"  连接错误: {self.stats['connection_errors']}")
        print(f"  超时错误: {self.stats['timeout_errors']}")
        
        if self.errors:
            print("")
            print("❌ 最近错误:")
            for error in self.errors[-5:]:
                print(f"  {error}")

if __name__ == "__main__":
    log_file = sys.argv[1] if len(sys.argv) > 1 else "/var/log/aria2.log"
    analyzer = Aria2LogAnalyzer(log_file)
    analyzer.analyze()
```

## 自动化下载管理

### 智能下载调度器

```python
#!/usr/bin/env python3
# aria2-scheduler.py - 智能下载调度器

import json
import time
import requests
import schedule
from datetime import datetime
import logging

class Aria2Scheduler:
    def __init__(self, rpc_url="http://localhost:6800/jsonrpc"):
        self.rpc_url = rpc_url
        self.download_queue = []
        self.max_concurrent = 5
        self.current_downloads = 0
        
        # 设置日志
        logging.basicConfig(
            level=logging.INFO,
            format='%(asctime)s - %(levelname)s - %(message)s',
            filename='aria2-scheduler.log'
        )
        self.logger = logging.getLogger(__name__)
    
    def add_download(self, uri, options=None):
        """添加下载任务到队列"""
        task = {
            'uri': uri,
            'options': options or {},
            'added_time': datetime.now(),
            'status': 'pending'
        }
        self.download_queue.append(task)
        self.logger.info(f"添加下载任务: {uri}")
    
    def start_download(self, task):
        """开始下载任务"""
        try:
            data = {
                "jsonrpc": "2.0",
                "id": "1",
                "method": "aria2.addUri",
                "params": [[task['uri']], task['options']]
            }
            
            response = requests.post(self.rpc_url, json=data, timeout=10)
            result = response.json()
            
            if 'result' in result:
                task['gid'] = result['result']
                task['status'] = 'downloading'
                self.current_downloads += 1
                self.logger.info(f"开始下载: {task['uri']} (GID: {task['gid']})")
                return True
            else:
                self.logger.error(f"下载失败: {task['uri']}")
                return False
                
        except Exception as e:
            self.logger.error(f"下载异常: {task['uri']} - {str(e)}")
            return False
    
    def check_completed_downloads(self):
        """检查已完成的下载"""
        try:
            data = {
                "jsonrpc": "2.0",
                "id": "1",
                "method": "aria2.tellActive",
                "params": []
            }
            
            response = requests.post(self.rpc_url, json=data, timeout=10)
            result = response.json()
            
            active_downloads = len(result.get('result', []))
            self.current_downloads = active_downloads
            
        except Exception as e:
            self.logger.error(f"检查下载状态失败: {str(e)}")
    
    def process_queue(self):
        """处理下载队列"""
        self.check_completed_downloads()
        
        # 处理队列中的任务
        for task in self.download_queue[:]:
            if task['status'] == 'pending' and self.current_downloads < self.max_concurrent:
                if self.start_download(task):
                    self.download_queue.remove(task)
        
        # 清理已完成的任务
        self.download_queue = [task for task in self.download_queue if task['status'] != 'completed']
    
    def run_scheduler(self):
        """运行调度器"""
        self.logger.info("启动 Aria2 下载调度器")
        
        # 设置定时任务
        schedule.every(30).seconds.do(self.process_queue)
        schedule.every().hour.do(self.log_status)
        
        while True:
            schedule.run_pending()
            time.sleep(1)
    
    def log_status(self):
        """记录状态"""
        self.logger.info(f"状态: 当前下载 {self.current_downloads}/{self.max_concurrent}, 队列中 {len(self.download_queue)} 个任务")

# 使用示例
if __name__ == "__main__":
    scheduler = Aria2Scheduler()
    
    # 添加下载任务
    scheduler.add_download("https://example.com/file1.zip")
    scheduler.add_download("https://example.com/file2.zip")
    scheduler.add_download("https://example.com/file3.zip")
    
    # 运行调度器
    scheduler.run_scheduler()
```

### 批量下载管理器

```bash
#!/bin/bash
# aria2-batch-manager.sh - 批量下载管理器

# 配置
DOWNLOAD_DIR="/data/downloads"
CONFIG_FILE="$HOME/.aria2/aria2.conf"
LOG_FILE="$HOME/.aria2/batch.log"
MAX_CONCURRENT=5

# 颜色输出
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# 日志函数
log() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1" | tee -a "$LOG_FILE"
}

# 检查 Aria2 是否运行
check_aria2() {
    if ! pgrep -x "aria2c" > /dev/null; then
        log "${RED}错误: Aria2 未运行${NC}"
        log "启动 Aria2..."
        aria2c --conf-path="$CONFIG_FILE" --daemon
        sleep 2
    fi
}

# 添加下载任务
add_download() {
    local url="$1"
    local filename="$2"
    
    log "${GREEN}添加下载: $url${NC}"
    
    if [ -n "$filename" ]; then
        aria2c --conf-path="$CONFIG_FILE" -o "$filename" "$url"
    else
        aria2c --conf-path="$CONFIG_FILE" "$url"
    fi
}

# 批量下载
batch_download() {
    local url_file="$1"
    
    if [ ! -f "$url_file" ]; then
        log "${RED}错误: URL 文件不存在: $url_file${NC}"
        exit 1
    fi
    
    log "${YELLOW}开始批量下载: $url_file${NC}"
    
    local count=0
    while IFS= read -r line; do
        # 跳过空行和注释
        [[ -z "$line" || "$line" =~ ^[[:space:]]*# ]] && continue
        
        # 解析 URL 和文件名
        if [[ "$line" =~ ^([^[:space:]]+)[[:space:]]+(.+)$ ]]; then
            url="${BASH_REMATCH[1]}"
            filename="${BASH_REMATCH[2]}"
        else
            url="$line"
            filename=""
        fi
        
        add_download "$url" "$filename"
        count=$((count + 1))
        
        # 控制并发数
        if [ $((count % MAX_CONCURRENT)) -eq 0 ]; then
            log "${YELLOW}等待下载队列处理...${NC}"
            sleep 10
        fi
    done < "$url_file"
    
    log "${GREEN}批量下载完成，共 $count 个任务${NC}"
}

# 监控下载状态
monitor_downloads() {
    log "${YELLOW}监控下载状态...${NC}"
    
    while true; do
        clear
        echo "=== Aria2 下载监控 ==="
        echo "时间: $(date)"
        echo "========================"
        
        # 显示活动下载
        echo "📥 活动下载:"
        aria2c --show-files --summary-interval=1 2>/dev/null | head -10
        
        # 显示队列状态
        echo ""
        echo "📋 队列状态:"
        aria2c --show-files 2>/dev/null | grep -c "pending" || echo "0"
        
        sleep 5
    done
}

# 主函数
main() {
    case "${1:-}" in
        "add")
            check_aria2
            add_download "$2" "$3"
            ;;
        "batch")
            check_aria2
            batch_download "$2"
            ;;
        "monitor")
            monitor_downloads
            ;;
        "status")
            aria2c --show-files
            ;;
        *)
            echo "用法: $0 {add|batch|monitor|status} [参数]"
            echo "  add <url> [filename]  - 添加单个下载"
            echo "  batch <url_file>      - 批量下载"
            echo "  monitor               - 监控下载状态"
            echo "  status                - 显示下载状态"
            exit 1
            ;;
    esac
}

main "$@"
```

## 安全配置

### SSL/TLS 配置

```ini
# SSL/TLS 安全配置
check-certificate=true
ca-certificate=/path/to/ca-certificates.crt
certificate=/path/to/client-cert.pem
private-key=/path/to/client-key.pem

# 代理设置
all-proxy=http://proxy.example.com:8080
all-proxy-user=username
all-proxy-passwd=password

# 安全下载设置
lowest-speed-limit=1K
max-overall-download-limit=0
max-download-limit=0
```

### 访问控制

```ini
# RPC 访问控制
rpc-allow-origin-all=false
rpc-allow-origin-all=true
rpc-listen-all=false
rpc-listen-address=127.0.0.1
rpc-secret=your_secure_secret_key

# 用户认证
rpc-user=aria2user
rpc-passwd=secure_password
```

## 性能基准测试

### 下载性能测试脚本

```bash
#!/bin/bash
# aria2-benchmark.sh - Aria2 性能基准测试

# 测试配置
TEST_URL="https://speed.hetzner.de/100MB.bin"
TEST_FILE="test_100mb.bin"
LOG_FILE="aria2_benchmark.log"

# 测试参数
CONCURRENT_TESTS=(1 2 4 8 16)
CONNECTION_TESTS=(1 4 8 16 32)

echo "=== Aria2 性能基准测试 ==="
echo "测试时间: $(date)"
echo "测试文件: $TEST_URL"
echo "================================"

# 清理旧文件
rm -f "$TEST_FILE" "$LOG_FILE"

# 基准测试函数
run_benchmark() {
    local connections="$1"
    local concurrent="$2"
    
    echo "测试配置: $connections 连接, $concurrent 并发"
    
    # 开始下载
    start_time=$(date +%s)
    aria2c -x "$connections" -s "$connections" -c "$TEST_URL" 2>/dev/null
    end_time=$(date +%s)
    
    # 计算性能指标
    duration=$((end_time - start_time))
    speed=$(echo "scale=2; 100 / $duration" | bc)
    
    echo "  耗时: ${duration}s"
    echo "  速度: ${speed}MB/s"
    echo "  连接数: $connections"
    echo "  并发数: $concurrent"
    echo "---"
    
    # 记录结果
    echo "$connections,$concurrent,$duration,$speed" >> "$LOG_FILE"
    
    # 清理测试文件
    rm -f "$TEST_FILE"
    sleep 2
}

# 运行测试
echo "开始性能测试..."
echo "connections,concurrent,duration,speed" > "$LOG_FILE"

for conn in "${CONNECTION_TESTS[@]}"; do
    for conc in "${CONCURRENT_TESTS[@]}"; do
        run_benchmark "$conn" "$conc"
    done
done

# 生成报告
echo ""
echo "=== 测试结果汇总 ==="
echo "最佳性能配置:"
sort -t',' -k4 -nr "$LOG_FILE" | head -5 | while IFS=',' read -r conn conc dur speed; do
    echo "  连接数: $conn, 并发数: $conc, 速度: ${speed}MB/s"
done

echo ""
echo "详细结果已保存到: $LOG_FILE"
```

## 总结

Aria2 是一个功能强大、灵活且高效的下载工具，适用于各种下载场景。通过本文档的学习，您应该能够：

1. **理解 Aria2 的核心特性**：多协议支持、高性能下载、断点续传等
2. **掌握安装和配置**：在不同平台上安装和配置 Aria2
3. **熟练使用基本功能**：命令行下载、多线程、断点续传等
4. **应用高级功能**：BitTorrent、Metalink、RPC 接口等
5. **解决常见问题**：性能优化、故障排除等
6. **集成到其他应用**：通过 RPC 和 WebSocket 接口集成
7. **实现自动化管理**：使用脚本和工具进行批量下载管理
8. **确保安全使用**：配置 SSL/TLS 和访问控制
9. **性能优化**：通过基准测试找到最佳配置

Aria2 的轻量级设计和强大的功能使其成为命令行下载工具的首选，特别适合需要自动化下载管理的场景。

## 参考资源

- [Aria2 官方文档](https://aria2.github.io/)
- [Aria2 GitHub 仓库](https://github.com/aria2/aria2)
- [Aria2 在线手册](https://aria2.github.io/manual/en/html/)
- [Aria2 RPC 接口文档](https://aria2.github.io/manual/en/html/aria2c.html#rpc-interface)
- [Aria2 配置示例](https://github.com/aria2/aria2/tree/master/doc)

---

*本文档基于 Aria2 1.37.0 版本编写，适用于大多数现代操作系统。* 